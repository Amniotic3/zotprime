version: '3.9'
services:
  db-zotprime-mysql:
    image: mariadb:10
   # command: --default-authentication-plugin=mysql_native_password
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQLROOTPASSWORD}
      - MYSQL_DATABASE=${MYSQLDATABASE}
      - MYSQL_USER=${MYSQLUSER}
      - MYSQL_PASSWORD=${MYSQLPASSWORD}
    volumes:
      - dbdata:/var/lib/mysql
  db-zotprime-elasticsearch:
#   image: docker.elastic.co/elasticsearch/elasticsearch:5.3.0
   image: docker.elastic.co/elasticsearch/elasticsearch:8.7.0
   environment:
     - cluster.name=zotero
     - xpack.security.enabled=false
     - cluster.routing.allocation.disk.threshold_enabled=false 
       #     - cluster.routing.allocation.disk.watermark.flood_stage=500mb
     - discovery.type=single-node
#   privileged: true
   #user: root
   #command: "sysctl -w vm.max_map_count=262144 && su elasticsearch -c bin/elasticsearch"
 #  sysctls:
 #           - vm.max_map_count=262144
#   command: "sysctl -w vm.max_map_count=262144"
  db-zotprime-redis:
     image: redis:5.0
 #   privileged: true
 #    user: root
 #    sysctls:
 #      - sysctl vm.overcommit_memory=1
  db-zotprime-memcached:
     image: memcached:1.5
  db-zotprime-localstack:
    image: atlassianlabs/localstack
    environment:
      - SERVICES=sns,sqs,apigateway
  db-zotprime-minio:
    image: minio/minio
    build:
      context: ./minio
    environment:
      - MINIO_ACCESS_KEY=zotero
      - MINIO_SECRET_KEY=zoterodocker
    command: server /data
  app-zotprime-dataserver:
    image: app-zotprime-dataserver
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:80"
#      - "8081:81"
      - "8082:8082"
    volumes:
      - "./dataserver/:/var/www/zotero:rw"
      - "./docker/config/config.inc.php:/var/www/zotero/include/config/config.inc.php:ro"
      - "./docker/config/dbconnect.inc.php:/var/www/zotero/include/config/dbconnect.inc.php:ro"
      - "./Zend/:/var/www/zotero/include/Zend:rw"
      - "./docker/config/header.inc.php:/var/www/zotero/include/header.inc.php:ro"
      - "./docker/config/Storage.inc.php:/var/www/zotero/model/Storage.inc.php:ro"
      - "./docker/dbinit/init-mysql.sh:/var/www/zotero/misc/init-mysql.sh:ro"
      - "./docker/dbinit/www.sql:/var/www/zotero/misc/www.sql:ro"
      - "./docker/dbinit/shard.sql:/var/www/zotero/misc/shard.sql:ro"
      - "./docker/config/create-user.sh:/var/www/zotero/admin/create-user.sh:ro"
    environment:
      - RUN_USER=www-data
      - RUN_GROUP=www-data
    depends_on:
      - db-zotprime-mysql
      - db-zotprime-elasticsearch
      - db-zotprime-redis
      - db-zotprime-memcached 
      - app-zotprime-tinymceclean
      - app-zotprime-streamserver
    links:
      - db-zotprime-mysql:mysql
      - db-zotprime-elasticsearch:elasticsearch
      - db-zotprime-redis:redis
      - db-zotprime-memcached:memcached
      - db-zotprime-localstack:localstack
      - db-zotprime-minio:minio
      - app-zotprime-tinymceclean:tinymceclean
      - app-zotprime-streamserver:streamserver
    restart: always
  app-zotprime-tinymceclean:
    image: app-zotprime-tinymceclean
    build:
      context: ./tinymce-clean-server/
      dockerfile: Dockerfile
#      ports:
#      - "16342:16342"
    depends_on:
      - db-zotprime-mysql
      - db-zotprime-elasticsearch
      - db-zotprime-redis
      - db-zotprime-memcached
    links:
      - db-zotprime-redis:redis 
    restart: always
  app-zotprime-streamserver:
    image: app-zotprime-streamserver
    build:
      context: ./stream-server/
      dockerfile: Dockerfile
    ports:
      - "8081:81"
    volumes:
      - "./docker/config/default.js:/usr/src/app/config/default.js:ro"
    restart: always
    depends_on:
      - db-zotprime-mysql
      - db-zotprime-elasticsearch
      - db-zotprime-redis
      - db-zotprime-memcached 
    links:
      - db-zotprime-redis:redis
  app-zotprime-phpmyadmin:
    image: phpmyadmin/phpmyadmin
    ports:
      - "8083:80"
    environment:
      - PMA_HOST=mysql
    links:
      - db-zotprime-mysql:mysql

volumes:
  dbdata:
   driver: local

